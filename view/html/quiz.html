<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" type="text/css" href="../css/quiz.css" media="screen" />
    <title>Quiz</title>
</head>
<body>
    <div class="faixa"></div>

    <div class="questao" id="caixaPergunta">
        <p>Se quiser sim</p> <!-- Texto da pergunta que será atualizado via JS -->
    </div>

    <div class="respostas"></div> <!-- Local onde as respostas serão inseridas dinamicamente -->

    <button class="btn-voltar" id="btnVoltar" type="button">Voltar</button> <!-- Botão para voltar -->

    <script>
        let caixaPergunta = document.getElementById("caixaPergunta");
        let cursoReferenciado = 1000; // ID do curso referenciado
        let vetorCursos = {}
        let idCursoNovos = 0
        // variavel resposnval para garantir que cada curso possam se repetir 
        let repeticaoCursoNovos = 1
        // 
        const pontosUsuario = {
            Pontos_Informatica: 1,
            Pontos_Eletronica: 1,
            Pontos_Publicidade: 1,
            Pontos_Administracao: 0,
            Pontos_Quimica: 0,
            Pontos_Analises: 0 
        };

        // Loop para buscar as perguntas e respostas
        for (let contadorPosicao = 1; contadorPosicao <= 9; contadorPosicao++) {

            // se existir conteudoo no vetor cursos 
            if  (vetorCursos)  { 
                if (vetorCursos.count == 2){
                //verifica a quatidade de cursos guardadaos no vetror para entrar nesse if a fim de cada questao de cada matearia se repetir 2 vezes

                if (repeticaoCursoNovos == 0 || repeticaoCursoNovos == 2 ){ 
                    //srotei das primeiras novas questao referenciado ao novo curso
                                    // como evitar repeticao ????

                cursoReferenciado  = random ( vetorCursos )
                repeticaoCursoNovos  = 1
                // zera para que possa garantir as proximas pergutnas de outras materias terem opurtunidades de repetir duas vezes

                }else  {
                repeticaoCursoNovos +=1 
                }

            //verifica a quatidade de cursos guardadaos no vetror para entrar nesse if a fim de cada questao de cada matearia se repetir 3 vezes
            }if (vetorCursos.count == 3){
                if (repeticaoCursoNovos == 0 || repeticaoCursoNovos == 3 ){ 
                    //srotei das primeiras novas questao referenciado ao novo curso
                    // como evitar repeticao ????

                    cursoReferenciado  = random ( vetorCursos )
                    repeticaoCursoNovos  = 1
                    // zera para que possa garantir as proximas pergutnas de outras materias terem opurtunidades de repetir duas vezes

                }else  {
                repeticaoCursoNovos +=1 
                }

            }
            let uri_get_questao = `/perguntas/${contadorPosicao}/${cursoReferenciado}`;
            
            // Fetch da pergunta
            fetch(uri_get_questao)
                .then((response) => response.json())
                .then((data) => {
                    console.log(data);
                    processarPerguntas(data);
                })
                .catch((error) => {
                    console.error("Error:", error);
                });

            // Fetch das respostas
            let uri_get_resposta = `/respostas/${cursoReferenciado}`;
            fetch(uri_get_resposta)
                .then((response) => response.json())
                .then((data) => {
                    console.log(data);
                    processarRespostas(data, contadorPosicao);
                })
                .catch((error) => {
                    console.error("Error:", error);
                });

            // Mudança do curso após a 3ª questão
            if (contadorPosicao == 3) {
                let uri_get_curso = `/perguntas/${contadorPosicao}/${idCursoRef}`; // Corrigido para não usar idCursoRef

                fetch(uri_get_curso)
                    .then((response) => response.json())
                    .then((data) => {
                        vetorCursos = data

                        console.log("Novo curso referenciado:", cursoReferenciado);
                    })
                    .catch((error) => {
                        console.error("Error:", error);
                    });
            }
        }
    }
        // Processamento das respostas e adição de botões
        function processarRespostas(txtResposta, posicao) {
            const divRespostas = document.querySelector('.respostas');
            divRespostas.innerHTML = ''; // Limpa as respostas anteriores

            txtResposta.dados.forEach((valor) => {
                const botaoResposta = document.createElement("button");
                botaoResposta.textContent = valor;
                botaoResposta.classList.add('resposta');
                
                botaoResposta.onclick = function () {
                    let conteudoResposta = botaoResposta.textContent;

                    let uri_get_pontoResposta = `/respostas/${posicao}/${conteudoResposta}`;
                    fetch(uri_get_pontoResposta)
                        .then((response) => response.json())
                        .then((data) => {
                            salvarPontos(data);

                            // Enviar pontos após a 3ª questão
                            if (posicao > 3) {
                                let uri_enviar_pontos = `/pontos`; // Altera para a rota de cálculo
                                fetch(uri_enviar_pontos, {
                                    method: 'POST',
                                    headers: {
                                        'Content-Type': 'application/json'
                                    },
                                    body: JSON.stringify(pontosUsuario) // Passando os pontos
                                })
                                .then((response) => response.json())
                                .then((data) => {
                                    console.log("Pontos enviados:", data);
                                })
                                .catch((error) => {
                                    console.error("Error ao enviar pontos:", error);
                                });
                            }
                        })
                        .catch((error) => {
                            console.error("Error:", error);
                        });
                };

                divRespostas.appendChild(botaoResposta);
            });
        }

        // Processamento da pergunta
        function processarPerguntas(data) {
            let txtPergunta = data.dados;
            caixaPergunta.textContent = txtPergunta; // Atualiza a pergunta na tela
        }

        // Função para salvar os pontos
        function salvarPontos(valorResposta) {
            console.log("Pontos recebidos:", valorResposta);
            /* a requisao chega como  
            
            status : true
            dados : "ifnormatica"
            */
            valorResposta.dados.forEach((valor) => {
                for (let campoUsuario in pontosUsuario) {
                    if (campoUsuario == valor) {
                        pontosUsuario[campoUsuario] += 1;
                    }
                }
            });
            
            console.log("Pontos atualizados:", pontosUsuario);
        }
    </script>
</body>
</html>
