<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" type="text/css" href="../css/quiz.css" media="screen" />
    <title>Quiz</title>
</head>
<body>
    <div class="faixa"></div>

    <div class="questao" id="caixaPergunta">
        <p>Se quiser sim</p> <!-- Texto da pergunta que será atualizado via JS -->
    </div>

    <div class="respostas"></div> <!-- Local onde as respostas serão inseridas dinamicamente -->

    <button class="btn-voltar" id="btnVoltar" type="button">Voltar</button> <!-- Botão para voltar -->

    <script>
          const bntVoltar = document.getElementById("btnVoltar")
        bntVoltar.onclick = function ( ) { 
            window.location = "../html/paginaInicial.html"
        }

        let caixaPergunta = document.getElementById("caixaPergunta");
        let cursoReferenciado = 1000; // ID do curso indefinido
        let vetorCursos = {}

        let idCursoNovos = 0
        let repeticaoCursoNovos = 0 // Controla a repetição dos cursos

        const pontosUsuario = {
            Pontos_Informatica: 0,
            Pontos_Eletronica: 0,
            Pontos_Publicidade: 0,
            Pontos_Administracao: 0,
            Pontos_Quimica: 0,
            Pontos_Analises: 0 
        };

        // Loop para buscar as perguntas e respostas
        for (let contadorPosicao = 1; contadorPosicao <= 9; contadorPosicao++) {

            // Verifica o vetorCursos para sorteio e repetição de cursos
            if (vetorCursos) {
                if (vetorCursos.length === 2 && (repeticaoCursoNovos === 0 || repeticaoCursoNovos === 2)) {
                    cursoReferenciado = random(vetorCursos); // Sorteio do curso
                    repeticaoCursoNovos = 1;
                } else if (vetorCursos.length === 3 && (repeticaoCursoNovos === 0 || repeticaoCursoNovos === 3)) {
                    cursoReferenciado = random(vetorCursos);
                    repeticaoCursoNovos = 1;
                } else {
                    repeticaoCursoNovos += 1;
                }
            }

            let uri_get_questao = `/perguntas/${contadorPosicao}/${cursoReferenciado}`;
            

            
            // Fetch da pergunta
            fetch(uri_get_questao)
                .then((response) => response.json())
                .then((data) => {
                    console.log(data);
                    processarPerguntas(data);
                })
                .catch((error) => {
                    console.error("Error:", error);
                });

            // Fetch das respostas
            let uri_get_resposta = `/respostas/${cursoReferenciado}`;
            fetch(uri_get_resposta)
                .then((response) => response.json())
                .then((data) => {
                    console.log(data);
                    processarRespostas(data, contadorPosicao);
                })
                .catch((error) => {
                    console.error("Error:", error);
                });

            // Mudança do curso após a 3ª questão
            if (contadorPosicao === 3) {
                let uri_get_curso = `/perguntas/${contadorPosicao}/${idCursoNovos}`;

                fetch(uri_get_curso)
                    .then((response) => response.json())
                    .then((data) => {
                        vetorCursos = data;
                        console.log("Novo curso referenciado:", cursoReferenciado);
                    })
                    .catch((error) => {
                        console.error("Error:", error);
                    });
            }
        }

        finalizarQuiz ()


        // Processamento das respostas e adição de botões
        function processarRespostas(respostas, posicao) {
            const divRespostas = document.querySelector('.respostas');
            divRespostas.innerHTML = ''; // Limpa as respostas anteriores

            respostas.forEach((resposta) => {
                const botaoResposta = document.createElement("button");
                botaoResposta.textContent = resposta.texto;
                botaoResposta.classList.add('resposta');
                
                botaoResposta.onclick = function () {
                    let conteudoResposta = botaoResposta.textContent;

                    let uri_get_pontoResposta = `/respostas/${posicao}/${conteudoResposta}`;
                    fetch(uri_get_pontoResposta)
                        .then((response) => response.json())
                        .then((data) => {
                            salvarPontos(data);
                        })
                        .catch((error) => {
                            console.error("Error:", error);
                        });
                };

                divRespostas.appendChild(botaoResposta);
            });
        }

        // Processamento da pergunta
        function processarPerguntas(data) {
            let txtPergunta = data.dados;
            caixaPergunta.textContent = txtPergunta;
        }

        // Função para salvar os pontos
        function salvarPontos(resposta) {
            console.log("Pontos recebidos:", resposta);

            // Atualiza o campo correspondente no objeto pontosUsuario
            pontosUsuario[resposta.pontos] += 1;

            console.log("Pontos atualizados:", pontosUsuario);
        }



        function finalizarQuiz() {
            // Enviar os pontos para o servidor ou mostrar um resumo
            fetch(`/respostas/`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(pontosUsuario)
            })
            .then(response => response.json())
            .then(data => {
                window.location.href = "../html/telaResultados"; // Altere para a URL da tela inicial do seu quiz
            })
            .catch(error => console.error("Erro ao finalizar o quiz:", error));
        }
    </script>
</body>
</html>
